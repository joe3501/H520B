###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V5.30.0.51174/W32 for ARM     12/Sep/2015  15:35:10 #
# Copyright 1999-2009 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  E:\H520B\FW\src\Project\main.c                           #
#    Command line =  E:\H520B\FW\src\Project\main.c -D DEBUG_VER -lcN         #
#                    E:\H520B\FW\src\Project\EWARMv5\Debug\List\ -o           #
#                    E:\H520B\FW\src\Project\EWARMv5\Debug\Obj\ --no_cse      #
#                    --no_unroll --no_inline --no_code_motion --no_tbaa       #
#                    --no_clustering --no_scheduling --debug --endian=little  #
#                    --cpu=Cortex-M3 -e --fpu=None --dlib_config "C:\Program  #
#                    Files\IAR Systems\Embedded Workbench                     #
#                    5.4\arm\INC\DLib_Config_Full.h" -I                       #
#                    E:\H520B\FW\src\Project\EWARMv5\..\ -I                   #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\App\ -I            #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\Drivers\ -I        #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\FatFs\ -I          #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\Lib\inc\ -I        #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC-CPU\ -I    #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC-LIB\ -I    #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uCOS-II\Ports #
#                    \ -I E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uCOS-II\ #
#                    Source\ -I E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC #
#                    -Probe\ -I E:\H520B\FW\src\Project\EWARMv5\..\..\usb_lib #
#                    \ -I "C:\Program Files\IAR Systems\Embedded Workbench    #
#                    5.4\arm\INC\" -Ol                                        #
#    List file    =  E:\H520B\FW\src\Project\EWARMv5\Debug\List\main.lst      #
#    Object file  =  E:\H520B\FW\src\Project\EWARMv5\Debug\Obj\main.o         #
#                                                                             #
#                                                                             #
###############################################################################

E:\H520B\FW\src\Project\main.c
      1          /**
      2          * @file main.c
      3          * @brief 2.4GPOS项目主程序
      4          *
      5          * @version V0.0.1
      6          * @author joe
      7          * @date 2010年4月26日
      8          * @note
      9          *		none
     10          *
     11          * @copy
     12          *
     13          * 此代码为深圳合杰电子有限公司项目代码，任何人及公司未经许可不得复制传播，或用于
     14          * 本公司以外的项目。本司保留一切追究权利。
     15          *
     16          * <h1><center>&copy; COPYRIGHT 2015 heroje</center></h1>
     17          */
     18          
     19          /* Private Includes ------------------------------------------------------------------*/
     20          #include "stm32f10x_lib.h"
     21          #include "ucos_ii.h"
     22          #include <string.h>
     23          #include <stdlib.h>
     24          #include "app.h"
     25          #include "hw_platform.h"
     26          #include "data_uart.h"
     27          #include "keypad.h"
     28          #include "TimeBase.h"
     29          #include "Terminal_para.h"
     30          #include "record.h"
     31          #include "stm32f10x_flash_config.h"
     32          #include "scanner.h"
     33          #include "usb_lib.h"
     34          #include "PCUsart.h"
     35          #include "JMemory.h"
     36          #include "usb_pwr.h"
     37          /* Private define ------------------------------------------------------------*/
     38          
     39          // Cortex System Control register address
     40          #define SCB_SysCtrl					((u32)0xE000ED10)
     41          // SLEEPDEEP bit mask
     42          #define SysCtrl_SLEEPDEEP_Set		((u32)0x00000004)
     43          
     44          
     45          
     46          /* Global variables ---------------------------------------------------------*/
     47          ErrorStatus			HSEStartUpStatus;							//Extern crystal OK Flag
     48          unsigned int		pos_state;									//POS state flag
     49          //unsigned char		factory_test_start_flag;
     50          
     51          
     52          // 0x20000000-0x20000010 此字节为主程序与BootCode间的参数传递区
     53          __no_init unsigned int status_iap @ "VENDOR_RAM";
     54          __no_init unsigned int nouse[3] @ "VENDOR_RAM";
     55          
     56          /* Private functions ---------------------------------------------------------*/
     57          static void Unconfigure_All(void);
     58          static void GPIO_AllAinConfig(void);
     59          void RCC_Configuration(void);
     60          
     61          /* External variables -----------------------------------------------*/
     62          extern	TTerminalPara			g_param;					//Terminal Param
     63          
     64          /*******************************************************************************
     65          * Function Name  : main
     66          * Description    : Main program.
     67          * Input          : None
     68          * Output         : None
     69          * Return         : None
     70          *******************************************************************************/
     71          int main(void)
     72          {
     73          	/* System Clocks Configuration **********************************************/
     74          	RCC_Configuration(); 
     75          #ifdef RELEASE_VER
     76          	/* NVIC Configuration *******************************************************/
     77          	NVIC_SetVectorTable(NVIC_VectTab_FLASH, IAP_SIZE);		//需要加密的 bootcode
     78          #else	
     79          	/* NVIC Configuration *******************************************************/
     80          	NVIC_SetVectorTable(NVIC_VectTab_FLASH, 0);
     81          #endif
     82          	
     83          	// Clear SLEEPDEEP bit of Cortex System Control Register
     84          	*(vu32 *) SCB_SysCtrl &= ~SysCtrl_SLEEPDEEP_Set;
     85          
     86          	Unconfigure_All();
     87          	// 数据串口(调试口)初始化
     88          	data_uart_init();
     89          
     90          #ifdef DEBUG_VER
     91          	printf("H520B startup...\n");
     92          #endif
     93          
     94          	//初始化时基函数
     95          	TimeBase_Init();
     96          
     97          	hw_platform_init();
     98          
     99          	app_startup();
    100          }
    101          
    102          /*******************************************************************************
    103          * Function Name  : RCC_Configuration
    104          * Description    : Configures the different system clocks.
    105          * Input          : None
    106          * Output         : None
    107          * Return         : None
    108          *******************************************************************************/
    109          void RCC_Configuration(void)
    110          {   
    111          	vu32 i=0;
    112          	/* RCC system reset(for debug purpose) */
    113          	RCC_DeInit();
    114          
    115          	/* Enable HSE							*/
    116          	RCC_HSEConfig(RCC_HSE_ON);
    117          	// 这里要做延时，才能兼容某些比较差的晶体，以便顺利起震	
    118          	for(i=0; i<200000; i++);
    119          
    120          	/* Wait till HSE is ready			*/
    121          	HSEStartUpStatus = RCC_WaitForHSEStartUp();
    122          
    123          	if(HSEStartUpStatus == SUCCESS)
    124          	{
    125          		/* Enable Prefetch Buffer		*/
    126          		FLASH_PrefetchBufferCmd(FLASH_PrefetchBuffer_Enable);
    127          
    128          		/* Flash 2 wait state			*/
    129          		FLASH_SetLatency(FLASH_Latency_2);
    130          
    131          		/* HCLK = SYSCLK					*/
    132          		RCC_HCLKConfig(RCC_SYSCLK_Div1); 
    133          
    134          		/* PCLK2 = HCLK					*/
    135          		RCC_PCLK2Config(RCC_HCLK_Div1); 
    136          
    137          		/* PCLK1 = HCLK/2					*/
    138          		RCC_PCLK1Config(RCC_HCLK_Div2);
    139          
    140          		/* PLLCLK = 12MHz * 6 = 72 MHz	*/
    141          		RCC_PLLConfig(RCC_PLLSource_HSE_Div1, RCC_PLLMul_6);
    142          
    143          		/* PLLCLK = 8MHz * 8 = 64 MHz	*/
    144          		//RCC_PLLConfig(RCC_PLLSource_HSE_Div2, RCC_PLLMul9);
    145          
    146          		/* Enable PLL						*/
    147          		RCC_PLLCmd(ENABLE);
    148          
    149          		/* Wait till PLL is ready		*/
    150          		while(RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET)
    151          		{
    152          		}
    153          
    154          		/* Select PLL as system clock source */
    155          		RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK);
    156          
    157          		/* Wait till PLL is used as system clock source */
    158          		while(RCC_GetSYSCLKSource() != 0x08)
    159          		{
    160          		}
    161          	}
    162          }
    163          
    164          /*******************************************************************************
    165          * Function Name  : Unconfigure_All
    166          * Description    : set all the RCC data to the default values 
    167          *                  configure all the GPIO as input
    168          * Input          : None
    169          * Output         : None
    170          * Return         : None
    171          *******************************************************************************/
    172          static void Unconfigure_All(void)
    173          {
    174          	//RCC_DeInit();
    175          
    176          	/* RCC configuration */
    177          	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ALL, DISABLE);
    178          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_ALL, DISABLE);
    179          
    180          	GPIO_AllAinConfig();
    181          }
    182          
    183          
    184          /*******************************************************************************
    185          * Function Name  : GPIO_AllAinConfig
    186          * Description    : Configure all GPIO port pins in Analog Input mode 
    187          *                  (floating input trigger OFF)
    188          * Input          : None
    189          * Output         : None
    190          * Return         : None
    191          *******************************************************************************/
    192          static void GPIO_AllAinConfig(void)
    193          {
    194          	GPIO_InitTypeDef GPIO_InitStructure;
    195          
    196          	/* Configure all GPIO port pins in Analog Input mode (floating input trigger OFF) */
    197          	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_All;
    198          	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
    199          	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
    200          	GPIO_Init(GPIOA, &GPIO_InitStructure);
    201          	GPIO_Init(GPIOB, &GPIO_InitStructure);
    202          	GPIO_Init(GPIOC, &GPIO_InitStructure);
    203          	//GPIO_Init(GPIOD, &GPIO_InitStructure);
    204          	//GPIO_Init(GPIOE, &GPIO_InitStructure);
    205          }
    206          
    207          /************************************************
    208          * Function Name  : EnterLowPowerMode()
    209          ************************************************/
    210          void EnterLowPowerMode(void)
    211          {
    212          	GPIO_InitTypeDef GPIO_InitStructure;
    213          
    214          	//先关闭所有外设的时钟
    215          	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ALL, DISABLE);
    216          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_ALL, DISABLE);
    217          	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_ALL, DISABLE);
    218          
    219          	//但是需要开启PWR模块的时钟
    220          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR, ENABLE); // Enable PWR clock
    221          
    222          	//进入低功耗模式
    223          	EXTI_ClearFlag(0xffff);
    224          	PWR_EnterSTOPMode(PWR_Regulator_ON, PWR_STOPEntry_WFI);
    225          }
    226          
    227          /************************************************
    228          * Function Name  : ExitLowPowerMode()
    229          ************************************************/
    230          void ExitLowPowerMode(void)
    231          {
    232          	GPIO_InitTypeDef GPIO_InitStructure;
    233          	//重新配置时钟
    234          	RCC_Configuration();
    235          
    236          	//开启系统中使用到的模块的时钟
    237          	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_GPIOB |
    238          		RCC_APB2Periph_GPIOC | RCC_APB2Periph_AFIO | RCC_APB2Periph_ADC1, ENABLE);
    239          
    240          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2 | RCC_APB1Periph_TIM3 | RCC_APB1Periph_SPI2 | RCC_APB1Periph_USB | RCC_APB1Periph_PWR, ENABLE);
    241          
    242          	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1 | RCC_AHBPeriph_CRC, ENABLE);
    243          
    244          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2 | RCC_APB1Periph_USART3, ENABLE);
    245          }
    246          
    247          
    248          /*******************************************************************************
    249          * Function Name  : assert_failed
    250          * Description    : Reports the name of the source file and the source line number
    251          *                  where the assert_param error has occurred.
    252          * Input          : - file: pointer to the source file name
    253          *                  - line: assert_param error line source number
    254          * Output         : None
    255          * Return         : None
    256          *******************************************************************************/
    257          
    258          //void assert_failed(u8* file, u32 line)
    259          //{ 
    260          /* User can add his own implementation to report the file name and line number,
    261          ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
    262          
    263          /* Infinite loop */
    264          //while (1)
    265          //{
    266          //}
    267          //}
    268          /******************* (C) COPYRIGHT 2008 STMicroelectronics *****END OF FILE****/
    269          

   Maximum stack usage in bytes:

     Function          .cstack
     --------          -------
     EnterLowPowerMode      8
     ExitLowPowerMode       8
     GPIO_AllAinConfig      8
     RCC_Configuration      8
     Unconfigure_All        8
     main                   8


   Section sizes:

     Function/Label                   Bytes
     --------------                   -----
     HSEStartUpStatus                    1
     pos_state                           4
     status_iap                          4
     nouse                              12
     main                               68
     RCC_Configuration                 140
     Unconfigure_All                    26
     GPIO_AllAinConfig                  60
     EnterLowPowerMode                  58
     ExitLowPowerMode                   48
     ??DataTable1                        4
     ?<Constant "H520B startup...\n">   20

 
   5 bytes in section .bss
  20 bytes in section .rodata
 404 bytes in section .text
  16 bytes in section VENDOR_RAM
 
 404 bytes of CODE  memory
  20 bytes of CONST memory
  21 bytes of DATA  memory

Errors: none
Warnings: 3
