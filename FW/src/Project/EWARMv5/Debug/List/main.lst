###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V5.30.0.51174/W32 for ARM     10/Oct/2015  17:26:09 #
# Copyright 1999-2009 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  E:\H520B\FW\src\Project\main.c                           #
#    Command line =  E:\H520B\FW\src\Project\main.c -D DEBUG_VER -lcN         #
#                    E:\H520B\FW\src\Project\EWARMv5\Debug\List\ -o           #
#                    E:\H520B\FW\src\Project\EWARMv5\Debug\Obj\ --no_cse      #
#                    --no_unroll --no_inline --no_code_motion --no_tbaa       #
#                    --no_clustering --no_scheduling --debug --endian=little  #
#                    --cpu=Cortex-M3 -e --fpu=None --dlib_config "C:\Program  #
#                    Files\IAR Systems\Embedded Workbench                     #
#                    5.4\arm\INC\DLib_Config_Full.h" -I                       #
#                    E:\H520B\FW\src\Project\EWARMv5\..\ -I                   #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\App\ -I            #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\Drivers\ -I        #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\FatFs\ -I          #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\Lib\inc\ -I        #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC-CPU\ -I    #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC-LIB\ -I    #
#                    E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uCOS-II\Ports #
#                    \ -I E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uCOS-II\ #
#                    Source\ -I E:\H520B\FW\src\Project\EWARMv5\..\..\uCOS\uC #
#                    -Probe\ -I E:\H520B\FW\src\Project\EWARMv5\..\..\usb_lib #
#                    \ -I "C:\Program Files\IAR Systems\Embedded Workbench    #
#                    5.4\arm\INC\" -Ol                                        #
#    List file    =  E:\H520B\FW\src\Project\EWARMv5\Debug\List\main.lst      #
#    Object file  =  E:\H520B\FW\src\Project\EWARMv5\Debug\Obj\main.o         #
#                                                                             #
#                                                                             #
###############################################################################

E:\H520B\FW\src\Project\main.c
      1          /**
      2          * @file main.c
      3          * @brief 2.4GPOS项目主程序
      4          *
      5          * @version V0.0.1
      6          * @author joe
      7          * @date 2010年4月26日
      8          * @note
      9          *		none
     10          *
     11          * @copy
     12          *
     13          * 此代码为深圳合杰电子有限公司项目代码，任何人及公司未经许可不得复制传播，或用于
     14          * 本公司以外的项目。本司保留一切追究权利。
     15          *
     16          * <h1><center>&copy; COPYRIGHT 2015 heroje</center></h1>
     17          */
     18          
     19          /* Private Includes ------------------------------------------------------------------*/
     20          #include "stm32f10x_lib.h"
     21          #include "ucos_ii.h"
     22          #include <string.h>
     23          #include <stdlib.h>
     24          #include "app.h"
     25          #include "hw_platform.h"
     26          #include "data_uart.h"
     27          #include "keypad.h"
     28          #include "TimeBase.h"
     29          #include "Terminal_para.h"
     30          #include "record_m.h"
     31          #include "stm32f10x_flash_config.h"
     32          #include "scanner.h"
     33          #include "usb_lib.h"
     34          #include "PCUsart.h"
     35          #include "JMemory.h"
     36          #include "usb_pwr.h"
     37          /* Private define ------------------------------------------------------------*/
     38          
     39          // Cortex System Control register address
     40          #define SCB_SysCtrl					((u32)0xE000ED10)
     41          // SLEEPDEEP bit mask
     42          #define SysCtrl_SLEEPDEEP_Set		((u32)0x00000004)
     43          
     44          
     45          
     46          /* Global variables ---------------------------------------------------------*/
     47          ErrorStatus			HSEStartUpStatus;							//Extern crystal OK Flag
     48          unsigned int		pos_state;									//POS state flag
     49          //unsigned char		factory_test_start_flag;
     50          
     51          
     52          // 0x20000000-0x20000010 此字节为主程序与BootCode间的参数传递区
     53          __no_init unsigned int status_iap @ "VENDOR_RAM";
     54          __no_init unsigned int nouse[3] @ "VENDOR_RAM";
     55          
     56          /* Private functions ---------------------------------------------------------*/
     57          static void Unconfigure_All(void);
     58          static void GPIO_AllAinConfig(void);
     59          void RCC_Configuration(void);
     60          
     61          /* External variables -----------------------------------------------*/
     62          extern	TTerminalPara			g_param;					//Terminal Param
     63          
     64          /*******************************************************************************
     65          * Function Name  : main
     66          * Description    : Main program.
     67          * Input          : None
     68          * Output         : None
     69          * Return         : None
     70          *******************************************************************************/
     71          int main(void)
     72          {
     73          	/* System Clocks Configuration **********************************************/
     74          	RCC_Configuration(); 
     75          //#ifdef RELEASE_VER
     76          	/* NVIC Configuration *******************************************************/
     77          //	NVIC_SetVectorTable(NVIC_VectTab_FLASH, IAP_SIZE);		//需要加密的 bootcode
     78          //#else	
     79          	/* NVIC Configuration *******************************************************/
     80          	NVIC_SetVectorTable(NVIC_VectTab_FLASH, 0);
     81          //#endif
     82          	
     83          	// Clear SLEEPDEEP bit of Cortex System Control Register
     84          	*(vu32 *) SCB_SysCtrl &= ~SysCtrl_SLEEPDEEP_Set;
     85          
     86          	Unconfigure_All();
     87          	// 数据串口(调试口)初始化
     88          	data_uart_init();
     89          
     90          #ifdef DEBUG_VER
     91          	printf("H520B startup...\r\n");
     92          #endif
     93          
     94          	//初始化时基函数
     95          	TimeBase_Init();
     96          
     97          	hw_platform_init();
     98          
     99          	app_startup();
    100          }
    101          
    102          /*******************************************************************************
    103          * Function Name  : RCC_Configuration
    104          * Description    : Configures the different system clocks.
    105          * Input          : None
    106          * Output         : None
    107          * Return         : None
    108          *******************************************************************************/
    109          void RCC_Configuration(void)
    110          {   
    111          	vu32 i=0;
    112          
    113          	/* RCC system reset(for debug purpose) */
    114          	RCC_DeInit();
    115          
    116          	/* Enable HSE							*/
    117          	RCC_HSEConfig(RCC_HSE_ON);
    118          	// 这里要做延时，才能兼容某些比较差的晶体，以便顺利起震	
    119          	for(i=0; i<200000; i++);
    120          
    121          	/* Wait till HSE is ready			*/
    122          	HSEStartUpStatus = RCC_WaitForHSEStartUp();
    123          
    124          	if(HSEStartUpStatus == SUCCESS)
    125          	{
    126          		/* Enable Prefetch Buffer		*/
    127          		FLASH_PrefetchBufferCmd(FLASH_PrefetchBuffer_Enable);
    128          
    129          		/* Flash 2 wait state			*/
    130          		FLASH_SetLatency(FLASH_Latency_2);
    131          
    132          		/* HCLK = SYSCLK					*/
    133          		RCC_HCLKConfig(RCC_SYSCLK_Div1); 
    134          
    135          		/* PCLK2 = HCLK					*/
    136          		RCC_PCLK2Config(RCC_HCLK_Div1); 
    137          
    138          		/* PCLK1 = HCLK/2					*/
    139          		RCC_PCLK1Config(RCC_HCLK_Div2);
    140          
    141          		/* PLLCLK = 12MHz * 6 = 72 MHz	*/
    142          		RCC_PLLConfig(RCC_PLLSource_HSE_Div1, RCC_PLLMul_6);
    143          
    144          		/* PLLCLK = 8MHz * 9 = 72 MHz	*/
    145          		//RCC_PLLConfig(RCC_PLLSource_HSE_Div1, RCC_PLLMul_9);
    146          
    147          		/* Enable PLL						*/
    148          		RCC_PLLCmd(ENABLE);
    149          
    150          		/* Wait till PLL is ready		*/
    151          		while(RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET)
    152          		{
    153          		}
    154          
    155          		/* Select PLL as system clock source */
    156          		RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK);
    157          
    158          		/* Wait till PLL is used as system clock source */
    159          		while(RCC_GetSYSCLKSource() != 0x08)
    160          		{
    161          		}
    162          	}
    163          }
    164          
    165          /*******************************************************************************
    166          * Function Name  : Unconfigure_All
    167          * Description    : set all the RCC data to the default values 
    168          *                  configure all the GPIO as input
    169          * Input          : None
    170          * Output         : None
    171          * Return         : None
    172          *******************************************************************************/
    173          static void Unconfigure_All(void)
    174          {
    175          	//RCC_DeInit();
    176          
    177          	/* RCC configuration */
    178          	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ALL, DISABLE);
    179          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_ALL, DISABLE);
    180          
    181          	GPIO_AllAinConfig();
    182          }
    183          
    184          
    185          /*******************************************************************************
    186          * Function Name  : GPIO_AllAinConfig
    187          * Description    : Configure all GPIO port pins in Analog Input mode 
    188          *                  (floating input trigger OFF)
    189          * Input          : None
    190          * Output         : None
    191          * Return         : None
    192          *******************************************************************************/
    193          static void GPIO_AllAinConfig(void)
    194          {
    195          	GPIO_InitTypeDef GPIO_InitStructure;
    196          
    197          	/* Configure all GPIO port pins in Analog Input mode (floating input trigger OFF) */
    198          	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_All;
    199          	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
    200          	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
    201          	GPIO_Init(GPIOA, &GPIO_InitStructure);
    202          	GPIO_Init(GPIOB, &GPIO_InitStructure);
    203          	GPIO_Init(GPIOC, &GPIO_InitStructure);
    204          	//GPIO_Init(GPIOD, &GPIO_InitStructure);
    205          	//GPIO_Init(GPIOE, &GPIO_InitStructure);
    206          }
    207          
    208          /************************************************
    209          * Function Name  : EnterLowPowerMode()
    210          ************************************************/
    211          void EnterLowPowerMode(void)
    212          {
    213          	GPIO_InitTypeDef GPIO_InitStructure;
    214          
    215          	stop_real_timer();
    216          	hw_platform_led_ctrl(LED_RED,0);
    217          	hw_platform_led_ctrl(LED_BLUE,0);
    218          	hw_platform_led_ctrl(LED_GREEN,0);
    219          	hw_platform_led_ctrl(LED_YELLOW,0);
    220          
    221          	//先关闭所有外设的时钟
    222          	//RCC_APB2PeriphClockCmd(RCC_APB2Periph_ALL, DISABLE);
    223          	//RCC_APB1PeriphClockCmd(RCC_APB1Periph_ALL, DISABLE);
    224          	//RCC_AHBPeriphClockCmd(RCC_AHBPeriph_ALL, DISABLE);
    225          
    226          	//但是需要开启PWR模块的时钟
    227          	RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR, ENABLE); // Enable PWR clock
    228          
    229          	// enable Debug in Stop mode
    230          	//DBGMCU->CR |= DBGMCU_CR_DBG_STOP;
    231          	
    232          	//进入低功耗模式
    233          	EXTI_ClearFlag(0xffff);
    234          	PWR_EnterSTOPMode(PWR_Regulator_ON, PWR_STOPEntry_WFI);
    235          }
    236          
    237          /************************************************
    238          * Function Name  : ExitLowPowerMode()
    239          ************************************************/
    240          void ExitLowPowerMode(void)
    241          {
    242          	GPIO_InitTypeDef GPIO_InitStructure;
    243          	//重新配置时钟
    244          	RCC_Configuration();
    245          
    246          	start_real_timer();
    247          	scanner_mod_init();
    248          }
    249          
    250          
    251          /*******************************************************************************
    252          * Function Name  : assert_failed
    253          * Description    : Reports the name of the source file and the source line number
    254          *                  where the assert_param error has occurred.
    255          * Input          : - file: pointer to the source file name
    256          *                  - line: assert_param error line source number
    257          * Output         : None
    258          * Return         : None
    259          *******************************************************************************/
    260          
    261          //void assert_failed(u8* file, u32 line)
    262          //{ 
    263          /* User can add his own implementation to report the file name and line number,
    264          ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
    265          
    266          /* Infinite loop */
    267          //while (1)
    268          //{
    269          //}
    270          //}
    271          /******************* (C) COPYRIGHT 2008 STMicroelectronics *****END OF FILE****/
    272          

   Maximum stack usage in bytes:

     Function          .cstack
     --------          -------
     EnterLowPowerMode      8
     ExitLowPowerMode       8
     GPIO_AllAinConfig      8
     RCC_Configuration      8
     Unconfigure_All        8
     main                   8


   Section sizes:

     Function/Label                     Bytes
     --------------                     -----
     HSEStartUpStatus                      1
     pos_state                             4
     status_iap                            4
     nouse                                12
     main                                 68
     RCC_Configuration                   140
     Unconfigure_All                      32
     GPIO_AllAinConfig                    60
     EnterLowPowerMode                    66
     ExitLowPowerMode                     16
     ?<Constant "H520B startup...\r\n">   20

 
   5 bytes in section .bss
  20 bytes in section .rodata
 382 bytes in section .text
  16 bytes in section VENDOR_RAM
 
 382 bytes of CODE  memory
  20 bytes of CONST memory
  21 bytes of DATA  memory

Errors: none
Warnings: 3
